{"componentChunkName":"component---src-templates-post-template-jsx","path":"/python/django/multiple-db/","result":{"data":{"site":{"siteMetadata":{"title":"Blog by 인간지능","subtitle":"깔끔한 프로그래밍","copyright":"© All rights reserved.","author":{"name":"인간지능","twitter":"#"},"disqusShortname":"bmh8993-github-io","url":"https://bmh8993.github.io/"}},"markdownRemark":{"id":"cefc4c1b-eb1d-55c3-8a47-af5b2f31c5b7","html":"<p>현재 내가 있는 회사(Dailyfunding)에서 새로운 프로젝트를 진행중이다.\n내가 담당하고 있는 백엔드는 python으로 Django 프레임워크를 사용하고 있다.\n현재 진행 중인 프로젝트에서 100여개의 크롤링 데이터를 사용해야하는데,\n크롤러가 python이 아닌 php로 개발되어져 있어서, 기존의 크롤러를 python으로 새로 만들기에는 많은 시간이 걸릴 것으로 판단했다.\n그래서 내린 결론은 Django에서 어떤 하나의 앱으로 접근했을 때에 크롤러가 쌓고 있는 데이터의 DB로 접근하도록 하는 것이다.\n찾아보니 Django 에서는 <code class=\"language-text\">multiple Databases</code> 기능을 제공한다.<br><br>\n아래 step은 공식문서를 기준을 작성 되었다.</p>\n<h2>Multiple Databases</h2>\n<ol>\n<li>\n<p><strong>Defining you databases</strong><br>\n첫번째 단계는 내가 사용할 데이터베이스에 대해서 Django에게 얘기해주는 것이다. 즉 세팅을 해야한다.\n데이터베이스에는 내가 선택한 세팅을 할 수 있는데, 주의 해야할 점이 있다면\n다른 데이터베이스가 선택되지 않은 경우에는 기본값으로 설정한 데이터베이스를 선택한다는 점이다.<br><br>\n아래의 코드는 공식문서를 참고한 내가 실제로 사용려는 코드이다 물론 db password는 진짜가 아니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">DATABASES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n<span class=\"token string\">'default'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'ENGINE'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'mysql.connector.django'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'NAME'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'db_name'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'USER'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'db_user'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'PASSWORD'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'db_password'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'HOST'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'PORT'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3306'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'TEST'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'CHARSET'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'COLLATION'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'utf8_general_ci'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'charset'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'use_pure'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"crawler\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'ENGINE'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'mysql.connector.django'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'NAME'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'db_name'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'USER'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'db_user'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'PASSWORD'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'db_password'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'HOST'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'PORT'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3306'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'TEST'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'CHARSET'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'COLLATION'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'utf8_general_ci'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'charset'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'use_pure'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 두가지 방법이 있다.</p>\n<h4>SQL로 직접 참조</h4>\n<h4>ORM으로 참조</h4>\n</li>\n</ol>\n<p>아래의 방법은 ORM으로 참조하는 방법을 설명한다.</p>\n<h2>Database Routers</h2>\n<ol start=\"2\">\n<li><strong>set up database routing scheme</strong><br>\nrequest를 받았을 때에 어떤 데이터베이스로 연결지어야 할지 결정을 해야하는데 이를 해주는 것이 라우터이다.\n라우터는 네가지 메소드를 제공하는 클래스이다.<br>\n<code class=\"language-text\">router.py</code>의 작성 위치는 해당 앱 하위에 생성하면 된다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">DB_routers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    데이터베이스의 연산을 제어하는 중계기\n    \"\"\"</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">db_for_read</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>hints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        daily_lab의 모델을 조회하는 경우 daily_lab_db로 중계한다.\n        \"\"\"</span>\n        <span class=\"token keyword\">if</span> model<span class=\"token punctuation\">.</span>_meta<span class=\"token punctuation\">.</span>app_label <span class=\"token operator\">==</span> <span class=\"token string\">\"daily_lab\"</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"daily_lab_db\"</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">db_for_write</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>hints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        daily_lab의 모델을 기록하는 경우 daily_lab_db로 중계한다.\n        \"\"\"</span>\n        <span class=\"token keyword\">if</span> model<span class=\"token punctuation\">.</span>_meta<span class=\"token punctuation\">.</span>app_label <span class=\"token operator\">==</span> <span class=\"token string\">\"daily_lab\"</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"daily_lab_db\"</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">allow_relation</span><span class=\"token punctuation\">(</span>elf<span class=\"token punctuation\">,</span> obj1<span class=\"token punctuation\">,</span> obj2<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>hints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        daily_lab의 모델과 관련된 관계접근을 허용한다.\n        \"\"\"</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj1<span class=\"token punctuation\">.</span>_meta<span class=\"token punctuation\">.</span>app_label <span class=\"token operator\">==</span> <span class=\"token string\">\"daily_lab\"</span> <span class=\"token keyword\">or</span>\n            obj2<span class=\"token punctuation\">.</span>_meta<span class=\"token punctuation\">.</span>app_label <span class=\"token operator\">==</span> <span class=\"token string\">\"daily_lab\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">allow_migrate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">,</span> app_label<span class=\"token punctuation\">,</span> model_name<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>hints<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        daily_lab의 migrate_file이 daily_lab_db에만 migrate 되도록한다.\n        \"\"\"</span>\n        <span class=\"token keyword\">if</span> app_label <span class=\"token operator\">==</span> <span class=\"token string\">\"daily_lab\"</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> db <span class=\"token operator\">==</span> <span class=\"token string\">\"daily_lab_db\"</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span></code></pre></div>\n<h2>Models</h2>\n<p>DB_settings와 router 클래스를 모두 작성하였다면 models를 작성해야하는데,\n어짜피 이미 짜여진 테이블 구조를 가져온다면 <code class=\"language-text\">instpectdb</code>라는 기능을 통해서 models의 내용을 가져오자.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">python manage.py inspectdb --database<span class=\"token operator\">=</span>daily_lab_db <span class=\"token operator\">></span> daily_lab/models.py</code></pre></div>\n<p>이렇게 해서 models.py를 열어보면 작성되어져 있다. 이후 View에서 ORM을 사용해서 data를 가져오면 된다.\n<br><br>\n이번 리서치를 통해서 다시한번 느낀다. 주니어 개발자로서 어디까지 가능한지 판단하지 말고 생각하고 찾아보는 것이다.\n그리고 그 어디까지는 상상불가라는 것이다. <code class=\"language-text\">multiple Databases</code> 생각하지도 못했다. 그저 CTO님의 제안이었다.\n로직 안에서만 가능한지를 생각하지말고 전체적인 부분에서도 생각해보자. 불가능은 없다.</p>\n<hr>\n<p>ref: <a href=\"https://docs.djangoproject.com/en/2.2/topics/db/multi-db\">django multi-db docs</a><br>\nref: <a href=\"https://django-orm-cookbook-ko.readthedocs.io/en/latest/multiple_databases.html\">multiple databases cook book</a><br>\nref: <a href=\"https://dooha.tistory.com/15\">multiple db two settings</a><br>\nref: <a href=\"https://tbang.tistory.com/65\">django instpectdb</a><br></p>","fields":{"tagSlugs":["/tags/django/"],"slug":"/python/django/multiple-db/"},"frontmatter":{"title":"Django / Multiple Databases 세팅하기","tags":["django"],"date":"2020-02-01T20:02:17.000Z","description":"Django에서 multiple DB를 사용하는 방법에 대해 알아봅시다.","path":"/python/django/multiple-db/","category":"Django"},"tableOfContents":"<ul>\n<li><a href=\"/python/django/multiple-db/#multiple-databases\">Multiple Databases</a></li>\n<li><a href=\"/python/django/multiple-db/#database-routers\">Database Routers</a></li>\n<li><a href=\"/python/django/multiple-db/#models\">Models</a></li>\n</ul>","headings":[{"value":"Multiple Databases","depth":2},{"value":"SQL로 직접 참조","depth":4},{"value":"ORM으로 참조","depth":4},{"value":"Database Routers","depth":2},{"value":"Models","depth":2}]}},"pageContext":{"slug":"/python/django/multiple-db/"}},"staticQueryHashes":[]}